<UserControl x:Class="ImAged.MVVM.View.HomeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ImAged.MVVM.View"
             mc:Ignorable="d" 
             d:DesignHeight="450" 
             d:DesignWidth="800"
             x:Name="Root">

    <UserControl.Resources>
        <!-- ContextMenu Style -->
        <Style TargetType="ContextMenu">
            <Setter Property="Background" Value="#2B2B2B"/>
            <Setter Property="BorderBrush" Value="#444"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ContextMenu">
                        <Border Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="6"
                            SnapsToDevicePixels="True">
                            <StackPanel IsItemsHost="True"
                                    KeyboardNavigation.DirectionalNavigation="Cycle"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DeleteMenuItemStyle" TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="border"
                        Background="{TemplateBinding Background}"
                        Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"
                                      RecognizesAccessKey="True"
                                      ContentSource="Header"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Normal hover becomes red -->
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#FF4444"/>
                                <Setter TargetName="border" Property="Background" Value="#FF4444"/>
                            </Trigger>
                            <!-- Disabled gray -->
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#777"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="MenuItem">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="border"
                        Background="Transparent"
                        Padding="{TemplateBinding Padding}"
                        CornerRadius="4"
                        SnapsToDevicePixels="True"
                        ClipToBounds="True">
                            <ContentPresenter VerticalAlignment="Center"
                                      RecognizesAccessKey="True"
                                      ContentSource="Header"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Normal Hover -->
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#444"/>
                            </Trigger>

                            <!-- Destructive Hover -->
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsHighlighted" Value="True"/>
                                    <Condition Property="Tag" Value="Destructive"/>
                                </MultiTrigger.Conditions>
                                <Setter TargetName="border" Property="Background" Value="#FF4444"/>
                                <Setter Property="Foreground" Value="White"/>
                            </MultiTrigger>

                            <!-- Disabled -->
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#777"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="40"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Height="40">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="0"/>
            </Grid.ColumnDefinitions>

            <TextBlock Text="Gallery"
               Foreground="White"
               FontFamily="pack://application:,,,/ImAged;component/Fonts/Poppins/#Poppins Bold"
               FontSize="20"
               VerticalAlignment="Center"
               Margin="0,0,0,0"/>

            <TextBox Grid.Column="1"
                     VerticalContentAlignment="Center"
                     HorizontalAlignment="Stretch"
                     Style="{StaticResource ModernTextbox}"
                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
        </Grid>

        <Separator Grid.Row ="1" Margin="0,0,0,0" Foreground="#383838" RenderTransformOrigin="0.5,0.5">
            <Separator.RenderTransform>
                <TransformGroup>
                    <ScaleTransform ScaleY="-1"/>
                    <SkewTransform/>
                    <RotateTransform/>
                    <TranslateTransform/>
                </TransformGroup>
            </Separator.RenderTransform>
        </Separator>

        <ScrollViewer  Grid.Row="2"
                   VerticalScrollBarVisibility="Auto" 
                   HorizontalScrollBarVisibility="Disabled" Margin="0,10,0,0"
                   VirtualizingStackPanel.IsVirtualizing="True"
                   VirtualizingStackPanel.VirtualizationMode="Recycling"
                   ScrollViewer.CanContentScroll="True">

            <ItemsControl ItemsSource="{Binding DateGroups}"
                         VirtualizingStackPanel.IsVirtualizing="True"
                         VirtualizingStackPanel.VirtualizationMode="Recycling"
                         VirtualizingStackPanel.ScrollUnit="Pixel">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Style="{StaticResource DateHeaderContainerStyle}">
                                <TextBlock Text="{Binding DisplayDate}" 
                                       Style="{StaticResource DateHeaderTextStyle}"/>

                                <ItemsControl ItemsSource="{Binding Files}"
                                             VirtualizingStackPanel.IsVirtualizing="True"
                                             VirtualizingStackPanel.VirtualizationMode="Recycling"
                                             VirtualizingStackPanel.ScrollUnit="Pixel">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button Command="{Binding DataContext.OpenTtlFileCommand,
                                      ElementName=Root}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource ImageButtonStyle}">
                                                <Border Style="{StaticResource ImageTileHoverStyle}">

                                                    <Border.ContextMenu>
                                                        <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                                                            <MenuItem Header="Open in Folder Location"
                                                                      Command="{Binding OpenInFolderCommand}"
                                                                      CommandParameter="{Binding}" />
                                                            <MenuItem Header="Delete Image File"
                                                                      Command="{Binding DeleteImageCommand}"
                                                                      CommandParameter="{Binding}" 
                                                                      Tag="Destructive"/>
                                                            
                                                        </ContextMenu>
                                                    </Border.ContextMenu>

                                                    <Border.Background>
                                                        <ImageBrush ImageSource="{Binding Thumbnail}"
                                                                Stretch="UniformToFill"
                                                                AlignmentX="Center"
                                                                AlignmentY="Center"
                                                                RenderOptions.BitmapScalingMode="HighQuality"/>
                                                    </Border.Background>

                                                    <Grid>
                                                        <!-- Blurred thumbnail background -->
                                                        <Image Source="{Binding Thumbnail}"
                                                               Stretch="UniformToFill"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               RenderOptions.BitmapScalingMode="HighQuality"
                                                               IsHitTestVisible="False">
                                                            <Image.CacheMode>
                                                                <BitmapCache RenderAtScale="1.0"/>
                                                            </Image.CacheMode>
                                                            
                                                        </Image>

                                                        <!-- Loading overlay -->
                                                        <Border Style="{StaticResource LoadingOverlayStyle}">
                                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                <ProgressBar Style="{StaticResource LoadingProgressBarStyle}"/>
                                                                <TextBlock Text="Loading..." 
                                                                       Style="{StaticResource LoadingTextStyle}"/>
                                                            </StackPanel>
                                                        </Border>

                                                        <!-- File info overlay (visible on hover) -->
                                                        <Border Style="{StaticResource FileInfoOverlayStyle}">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                </Grid.RowDefinitions>

                                                                <!-- Row 0: File name -->
                                                                <TextBlock Grid.Row="0"
                                                                           Text="{Binding FileName}"
                                                                           Style="{StaticResource FileNameTextStyle}"/>

                                                                <!-- Row 1: Expiry left, Remaining time right -->
                                                                <Grid Grid.Row="1">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <TextBlock Grid.Column="0"
                                                                               Text="{Binding ExpirationLocal, StringFormat='{}{0:MM-dd hh:mm tt}'}"
                                                                               Foreground="#9CA3AF"
                                                                               VerticalAlignment="Center"/>

                                                                    <TextBlock Grid.Column="1"
                                                                               Text="{Binding EstimatedRemainingTime}"
                                                                               Foreground="#9CA3AF"
                                                                               VerticalAlignment="Center"/>
                                                                </Grid>
                                                            </Grid>
                                                        </Border>
                                                    </Grid>
                                                </Border>
                                            </Button>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>